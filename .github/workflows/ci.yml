name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio ruff

      - name: Lint with Ruff
        run: |
          ruff check . --ignore E501,F401 --exclude __pycache__

      - name: Run unit tests
        run: |
          pytest tests/test_agents_lite.py -v --ignore-glob="*integration*" -k "not integration"

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ruff
        run: pip install ruff

      - name: Check formatting
        run: ruff check . --ignore E501,F401,E402 --exclude __pycache__,data_store

  build:
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify imports
        run: |
          python -c "from agents import QueryFilterAgentLite; print('Agents OK')"
          python -c "from data.search_lite import HybridSearch; print('Search OK')"
          python -c "from utils import get_rate_limiter; print('Utils OK')"

      - name: Build check passed
        run: echo "âœ… All checks passed!"
